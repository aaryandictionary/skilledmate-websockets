import json
from datetime import datetime
import pytz
import boto3
import botocore
from aws_requests_auth.aws_auth import AWSRequestsAuth
import requests
from decimal import Decimal
import os
import sys
import logging
import pymysql

rds_host  = "skilledmate.cfbz13lsgo8m.ap-south-1.rds.amazonaws.com"
name = "SkilledMate"
password = "SkilledMate1998"
db_name = "skilledmate"

logger = logging.getLogger()
logger.setLevel(logging.INFO)

try:
    conn = pymysql.connect(rds_host, user=name, passwd=password, db=db_name, connect_timeout=5)
except pymysql.MySQLError as e:
    logger.error("ERROR: Unexpected error: Could not connect to MySQL instance.")
    logger.error(e)
    sys.exit()


def applambda(event,context):
    connectionId=event["requestContext"]["connectionId"]
    # userId=event["queryStringParameters"]["userId"]
    tz = pytz.timezone('Asia/Kolkata')
    MessageDateTime=str(datetime.now(tz))

    myCursor=conn.cursor()
    # lrUserId="SELECT last_receiver_id FROM users WHERE connection_id='"+connectionId+"'"
    # myCursor.execute(lrUserId)
    # id=myCursor.fetchone()[0]

    sql="UPDATE users SET users.is_connected ='"+str(0)+"',users.seen_status='"+str(MessageDateTime)+" WHERE users.connection_id="+str(connectionId)
    myCursor.execute(sql)
    conn.commit()

    return {
        'isBase64Encoded':False,
        'statusCode': 200,
        'headers':{'status':'success'},
        'body': 'success'
    }

    # if id!="-1":
    #     lrUserCId="SELECT connection_id FROM users WHERE id='"+str(id)+"' AND is_connected ='1'"
    #     conId=myCursor.execute(lrUserCId)
    #     if conId is not None:
    #         selConId=conId[0]
    #         jsonObjToSend={"last_seen":MessageDateTime}
    #         sendDirectMessage(selConId,jsonObjToSend)


    # return {"statusCode":200,"body":str(jsonObjToSend)}
 

# def sendDirectMessage(token,jsonobj):
#     access_key=os.environ['access_key']
#     secret_key=os.environ['secret_key']

#     auth=AWSRequestsAuth(aws_access_key=access_key,
#                         aws_secret_access_key=secret_key,aws_host='g5961tky75.execute-api.ap-south-1.amazonaws.com',
#                         aws_region='ap-south-1',aws_service='execute-api')

#     url='https://g5961tky75.execute-api.ap-south-1.amazonaws.com/production/%40connections/'+token.replace("=","")+"%3D"
#     req=requests.post(url,auth=auth,data=str(jsonobj))
