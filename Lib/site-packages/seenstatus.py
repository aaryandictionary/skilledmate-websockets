import json
from datetime import datetime
import boto3
import botocore
from aws_requests_auth.aws_auth import AWSRequestsAuth
import requests
from decimal import Decimal
import os
import sys
import logging
import pymysql

rds_host  = "skilledmate.cfbz13lsgo8m.ap-south-1.rds.amazonaws.com"
name = "SkilledMate"
password = "SkilledMate1998"
db_name = "skilledmate"

logger = logging.getLogger()
logger.setLevel(logging.INFO)

try:
    conn = pymysql.connect(rds_host, user=name, passwd=password, db=db_name, connect_timeout=5)
except pymysql.MySQLError as e:
    logger.error("ERROR: Unexpected error: Could not connect to MySQL instance.")
    logger.error(e)
    sys.exit()


def applambda(event,context):
    connectionId=event["requestContext"]["connectionId"]
    body=json.loads(event["body"])

    userId=body["userId"]
    lrId=body["lrId"]
    # MessageDateTime=str(datetime.now().timestamp())

    sql="UPDATE users SET users.last_receiver_id ='"+str(lrId)+"' WHERE users.id="+str(userId)

    myCursor=conn.cursor()
    myCursor.execute(sql)

    conn.commit()

    myStatus="SELECT seen_status FROM users WHERE id="+userId
    myCursor.execute(myStatus)
    userStatus=myCursor.fetchone()[0]

    seenStatus=""
    lrUser="SELECT seen_status,connection_id,is_connected FROM users WHERE id='"+str(lrId)+"'"
    myCursor.execute(lrUser)
    status=myCursor.fetchone()
    if status is not None:
        seenStatus=status[0]
        if status[2]==1:
            jsonToSend={"last_seen":userStatus}
            sendDirectMessage(status[1],jsonToSend)
        jsonToReturn={"last_seen":seenStatus}

    return {"statusCode":200,"body":str(jsonToReturn)}

def sendDirectMessage(token,jsonobj):
    access_key=os.environ['access_key']
    secret_key=os.environ['secret_key']

    auth=AWSRequestsAuth(aws_access_key=access_key,
                        aws_secret_access_key=secret_key,aws_host='g5961tky75.execute-api.ap-south-1.amazonaws.com',
                        aws_region='ap-south-1',aws_service='execute-api')

    url='https://g5961tky75.execute-api.ap-south-1.amazonaws.com/production/%40connections/'+token.replace("=","")+"%3D"
    req=requests.post(url,auth=auth,data=str(jsonobj))